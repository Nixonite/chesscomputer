<html>
<head>
	<script src="/assets/elo_odds.js"></script>
	<script src="/assets/jquery-1.11.1.min.js"></script>
	<script src="/assets/jchess.js"></script>
	<script src="/assets/jquery.xdomainajax.js"></script>
 	<!-- <link rel="stylesheet" href="stylesheets/main.css" type="text/css" media="screen" title="no title" charset="utf-8"> -->
 	<link rel="stylesheet" href="stylesheets/chess.css" type="text/css" media="screen" title="no title" charset="utf-8">
 	<link rel="stylesheet" href="/assets/main.css" type="text/css" />

	<script>
	
	function positionOddsToString(odds){
		result = "";
		n = Math.round(odds*100);
		if(n > 50){
			result += n + "% white victory";
		}
		if(n < 50){
			result += (100-n) + "% black victory";
		}

		if(n == 50){
			result += " 50/50.";
		}


		return result;
	}

	function checkLiveGames() {
		
		pgn = ""

		$.ajax({
   			url: "/pgn_proxy",
   			url: "http://gregborenstein.com/assets/chess/games.pgn",
		    type: 'GET',
		    success: function(res) {
		    	console.log(res);
		    	$("#boards").empty();
		    
		    	pgn = res
		    	pgn = $($(res.responseText)[5]).text();
		    	parts = pgn.split(/\[Event/);

		    	console.log(parts);
		    	 currGame = 0;
		    	for(var i = 1; i < parts.length; i+=2){
		    		gameString = "[Event" + parts[i];
		    		boardId = "game"+currGame;
		    		console.log(boardId);
		    		$("#boards").append("<div class='game' id='"+boardId+"'></div>");
		    		console.log(gameString);
		    		chess = $("#"+boardId).chess({pgn:gameString, square_size: 21.5});
		    		console.log(chess);
		    		chess.transitionTo(chess.game.moves.length-1);
		    		console.log(chess.game.moves);
		    		h = chess.game.header;



					$("#" +boardId).append("<div class='live-score'><p class='score'>Calculating...</p><p class='best-move'></p></div><p class='matchup'><span class='whiteElo'>"+h.WhiteElo+"</span> <a class='white' href='/player/ashley'>"+h.White+"</a><br /><a class='black' href='/player/carlsen'>"+h.Black+"</a> <span class='blackElo'>"+h.BlackElo+"</span></p>\
					    <p class='odds'>"+eloString(parseInt(h.WhiteElo), parseInt(h.BlackElo))+"</p>");




		    		currGame++;
		    		console.log(boardId);
		    		console.log(gameString)
		    		$.ajax({
					  type: 'POST',
					  url: "/current_score",
					  data: {pgn:gameString, boardId: boardId},
					  dataType: 'json',
					  success:function(data){
					  	console.log(data);
					  	console.log(data.boardId);


					  	$("#"+data.boardId + " .best-move").html((data.current_move == "w" ? "White's" : "Black's ") + " move: "+ data.best_move);

					  	$("#"+data.boardId + " .score").html(positionOddsToString(data.white_victory_odds));
					  }
					});
		    	}
		    }
		});
		    

	}

	function ready(){
		checkLiveGames();
		setInterval(checkLiveGames, 5000);
	}
	document.addEventListener("DOMContentLoaded", ready, false);
	
	</script>
	<style>
	.chessboard img {
		width: 100%;
		height: 100%;
	}
	</style>

</head>

<body>
	<h1>Live Games</h1>
	<div id="boards"></div>
</body>
</html>
