<html>
<head>
	<script src="/assets/elo_odds.js"></script>
	<script src="/assets/jquery-1.11.1.min.js"></script>
	<script src="/assets/jchess.js"></script>
	<script src="/assets/jquery.xdomainajax.js"></script>
 	<!-- <link rel="stylesheet" href="stylesheets/main.css" type="text/css" media="screen" title="no title" charset="utf-8"> -->
 	<link rel="stylesheet" href="stylesheets/chess.css" type="text/css" media="screen" title="no title" charset="utf-8">
 	<link rel="stylesheet" href="/assets/main.css" type="text/css" />

	<script>

	var liveGames = {};
	var hasStockfish = false;
	
	function positionOddsToString(odds){
		result = "";
		n = Math.round(odds*100);
		if(n > 50){
			result += n + "% white victory";
		}
		if(n < 50){
			result += (100-n) + "% black victory";
		}

		if(n == 50){
			result += " 50/50.";
		}


		return result;
	}

	function keyForGame(chessGame){
		return chessGame.header.White + "/" + chessGame.header.Black + "/" + (chess.game.moves.length-1).toString();
	}

	function updateScore(data){
		$("#"+data.boardId + " .best-move").html((data.current_move == "w" ? "White's" : "Black's ") + " move: "+ data.best_move);

		$("#"+data.boardId + " .score").html(positionOddsToString(data.white_victory_odds));
	}



	function checkLiveGames() {
		
		pgn = ""
		$.ajax({
   			url: "/pgn_proxy",
   			url: "http://gregborenstein.com/assets/chess/games.pgn",
		    type: 'GET',
		    success: function(res) {
		    	$("#boards").empty();
		    
		    	pgn = res
		    	pgn = $($(res.responseText)[5]).text();
		    	parts = pgn.split(/\[Event\s/);

		    	console.log(parts);

		    	currGame = 0;

		    	for(var i = 1; i < parts.length; i++){
		    		gameString = "[Event" + parts[i];
		    		boardId = "game"+currGame;
		    		$("#boards").append("<div class='game' id='"+boardId+"'></div>");
		    		chess = $("#"+boardId).chess({pgn:gameString, square_size: 21.5});
		    		chess.transitionTo(chess.game.moves.length-1);
		    		h = chess.game.header;
					
					matchupUrl = "/matchup/" + encodeURIComponent(h.White) + "/v/" + encodeURIComponent(h.Black);
	
					$("#" +boardId).append("<div class='live-score'><p class='score'>Calculating...</p><p class='best-move'></p>	</div><p class='matchup'><span class='whiteElo'>"+h.WhiteElo+"</span> <a class='white' 	href='"+matchupUrl+"'>"+h.White+"</a><br /><a class='black' href='"+matchupUrl+"'>"+h.Black+"</a> <span class='blackElo'>"+h.BlackElo+"</span></p>\
					    <p class='odds'>"+eloString(parseInt(h.WhiteElo), parseInt(h.BlackElo))+"</p>");
	
		    		currGame++;
		    		//console.log(liveGames);
	
		    		if(keyForGame(chess.game) in liveGames){
		    			// console.log("known pos: " + keyForGame(chess.game) );
		    			updateScore(liveGames[keyForGame(chess.game)].scoreData);
		    		} else {
						  	console.log(hasStockfish);

						if(hasStockfish){
		    				$.ajax({
							  type: 'POST',
							  url: "/stockfish_query",
							  data: {pgn:gameString, boardId: boardId, positionKey: keyForGame(chess.game)},
							  dataType: 'json',
							  success:function(data){
							  	// console.log("new pos: " + data.positionKey);
							  	liveGames[data.positionKey] = {pgn : gameString, scoreData : data};
							  	updateScore(data);
							  	console.log(data);
							  	$.ajax({
							  		type: 'POST',
							  		url: "http://millionaire-chess.herokuapp.com/position_result", // this should be the remote server
							  		data: {fen:data.fen, score:data.score, bestmove:data.bestmove},
							  		dataType: 'json',
							  		success:function(data){
							  			console.log("saved to remove server");
							  			// console.log("new pos: " + data.positionKey);
							  			// liveGames[data.positionKey] = {pgn : gameString, scoreData : data};
							  			// updateScore(data);
							  			
							  		}
	
							  	});
							  }
							});
		    			} else {
							$.ajax({
							  type: 'GET',
							  url: "/current_score",
							  data: {pgn:gameString, boardId: boardId, positionKey: keyForGame(chess.game)},
							  dataType: 'json',
							  success:function(data){
							  	if(data.found){
							  		console.log("new pos: " + data.positionKey);
							  		liveGames[data.positionKey] = {pgn : gameString, scoreData : data};
							  		updateScore(data);
							  	}else{
							  		console.log("pos not ready yet");
							  	}

							  }
							});
		    			}
		    		}
		    	}
		    }
		});
		    

	}

	function ready(){
		if(window.location.search.split("=")[0] == "?stockfish" && window.location.search.split("=")[1] == "1"){
			hasStockfish = true;
		}

		checkLiveGames();
		setInterval(checkLiveGames, 5000);
	}
	document.addEventListener("DOMContentLoaded", ready, false);
	
	</script>
	<style>
	.chessboard img {
		width: 100%;
		height: 100%;
	}
	</style>

</head>

<body>
	<h1>Live Games</h1>
	<div id="boards"></div>
</body>
</html>
