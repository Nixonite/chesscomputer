<html>
<head>
	<script src="/assets/elo_odds.js"></script>
	<script src="/assets/jquery-1.11.1.min.js"></script>
	<script src="/assets/jchess.js"></script>
	<script src="/assets/jquery.xdomainajax.js"></script>
 	<!-- <link rel="stylesheet" href="stylesheets/main.css" type="text/css" media="screen" title="no title" charset="utf-8"> -->
 	<link rel="stylesheet" href="stylesheets/chess.css" type="text/css" media="screen" title="no title" charset="utf-8">
 	<link rel="stylesheet" href="/assets/main.css" type="text/css" />

	<script>
	// function getFen( boardData ) {
	// 	var fen = "";
	// 	for(var row=0; row< 8; row++){
	// 		for(var col = 0; col < 8; col++){
	// 			entry = boardData[row][col];
	// 			if(entry == "-" ){
	// 				fen = fen.concat("1");
	// 			} else{
	// 				fen = fen.concat(entry.piece);
	// 			}
	// 		}
	// 		if(row < 7){
	// 			fen = fen.concat("/")
	// 		}
	// 	}

	// 	fen = fen.replace(/11111111/g, "8")
	// 			 .replace(/1111111/g, "7")
	// 			 .replace(/111111/g, "6")
	// 			 .replace(/11111/g, "5")
	// 			 .replace(/1111/g, "4")
	// 			 .replace(/111/g, "3")
	// 			 .replace(/11/g, "2");

	// 	return fen;
	// }

	

	function positionOddsToString(odds){
		result = "Position odds: ";
		n = Math.round(odds*100);
		if(n > 50){
			result += n + "% of white victory";
		}
		if(n < 50){
			result += (100-n) + "% of black victory";
		}

		if(n == 50){
			result += " 50/50.";
		}


		return result;
	}

	function ready(){
		pgn = ""
		$.ajax({
   			url: "http://gregborenstein.com/assets/chess/games.pgn",
		    type: 'GET',
		    success: function(res) {
		    	pgn = $($(res.responseText)[5]).text();

		    	parts = pgn.split(/\[Event/);
		    	currGame = 0;
		    	for(var i = 1; i < parts.length; i+=2){
		    		gameString = "[Event" + parts[i];
		    		boardId = "game"+currGame;
		    		$("#boards").append("<div class='game' id='"+boardId+"'></div>");
		    		chess = $("#"+boardId).chess({pgn:gameString, square_size: 21.5});
		    		chess.transitionTo(chess.game.moves.length);
		    		console.log(chess);
		    		h = chess.game.header;

					$("#" +boardId).append("<p class='score'>Calculating...</p><p class='matchup'><span class='whiteElo'>"+h.WhiteElo+"</span> <a class='white' href='/player/ashley'>"+h.White+"</a> v. <a class='black' href='/player/carlsen'>"+h.Black+"</a> <span class='blackElo'>"+h.BlackElo+"</span></p>\
					    <p class='odds'>"+eloString(parseInt(h.WhiteElo), parseInt(h.BlackElo))+"</p>");

		    		currGame++;
		    		console.log(boardId);
		    		console.log(gameString)
		    		$.ajax({
					  type: 'POST',
					  url: "/current_score",
					  data: {pgn:gameString, boardId: boardId},
					  dataType: 'json',
					  success:function(data){
					  	console.log(data);
					  	console.log(data.boardId);
					  	$("#"+data.boardId + " .score").html(positionOddsToString(data.white_victory_odds));
					  }
					});


		    	}


		    }
		});



	}
	document.addEventListener("DOMContentLoaded", ready, false);
	
	</script>
	<style>
	.chessboard img {
		width: 100%;
		height: 100%;
	}
	</style>

</head>

<body>
	<div id="boards"></div>
</body>
</html>
